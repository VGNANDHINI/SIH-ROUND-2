
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isUserInRole(role) {
      // In a real app, you would have a 'roles' claim or similar.
      // For this prototype, we'll check a user's email or a field in their profile.
      // e.g. return request.auth.token.role == role;
      // For now, we'll just check if they are authenticated.
      return request.auth != null;
    }

    match /users/{userId} {
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.uid == userId
                    && request.resource.data.displayName is string
                    && request.resource.data.email is string
                    && request.resource.data.phoneNumber is string
                    && ('createdAt' in request.resource.data)
                    && request.resource.data.state is string
                    && request.resource.data.district is string
                    && request.resource.data.block is string
                    && request.resource.data.panchayat is string;

      allow read: if request.auth != null
                  && request.auth.uid == userId;

      allow update: if request.auth != null
                    && request.auth.uid == userId;
    }

    match /pumpLogs/{logId} {
      allow read, write: if request.auth != null;
    }
    
    match /predictive_maintenance_logs/{logId} {
      allow read, create: if request.auth != null;
    }

    match /water_quality_logs/{logId} {
      allow read, create: if request.auth != null;
    }

    match /waterSchemes/{schemeId} {
      allow read, write: if request.auth != null;
    }
    
    match /waterSchedules/{panchayatId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.panchayat == panchayatId;
    }

    match /pumpIssues/{issueId} {
      allow read, write: if request.auth != null;
    }

    match /bills/{billId} {
      allow read, write: if request.auth != null;
    }

    match /waterSupply/{pumpId} {
      allow read, write: if request.auth != null;
    }

    match /operators/{operatorId} {
      allow read, write: if request.auth != null;
    }
    
    match /test_connection/{alertId} {
      // Allow Colab backend to write, and authenticated users to read.
      allow read: if request.auth != null;
      // In production, you would secure this with a service account or API key check
      allow write: if true; 
    }

    match /complaints/{complaintId} {
      // Allow client-side creation if user is creating their own complaint.
      // Allow server-side creation (e.g., from SMS) where request.auth is null.
      allow create: if (request.auth != null && request.auth.uid == request.resource.data.userId) || request.auth == null;
      allow read: if request.auth != null;
      allow update, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.panchayat == resource.data.userPanchayat;
    }

    match /panchayats/{panchayatId}/waterTests/{testId} {
        // Assume user profile has 'panchayatId' and 'role' fields
        // 'operator', 'gp_user', 'be_user'
        let userProfile = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        let userRole = userProfile.role; // This field needs to be added to userProfile

        allow create: if isUserInRole('operator') && userProfile.panchayat == panchayatId;
        
        allow read: if (isUserInRole('operator') && request.auth.uid == resource.data.operatorId)
                   || (isUserInRole('gp_user') && userProfile.panchayat == panchayatId)
                   || (isUserinRole('block-official') && userProfile.block == get(/databases/$(database)/documents/panchayats/$(panchayatId)).data.blockId);
        
        // No one can update after creation, except cloud functions
        allow update, delete: if false;
    }
    
    match /daily_leak_checks/{checkId} {
      allow read, create: if request.auth != null;
    }

    match /panchayats/{panchayatId}/checklists/{checklistId} {
        let userProfile = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        let isOperatorForPanchayat = userProfile.panchayat == panchayatId && userProfile.role == 'pump-operator';
        let isGPForPanchayat = userProfile.panchayat == panchayatId && userProfile.role == 'gram-panchayat';
        
        allow create: if isOperatorForPanchayat && request.resource.data.operatorId == request.auth.uid;
        allow update: if isOperatorForPanchayat && request.resource.data.operatorId == request.auth.uid;
        allow read: if isOperatorForPanchayat || isGPForPanchayat;
    }

    match /sopLibrary/{sopId} {
      allow read: if request.auth != null;
      allow write: if false; // Only admins can write
    }
    
    // GIS Data Rules
    match /gis_assets/{villageId}/{assetCollection}/{assetId} {
      allow read: if request.auth != null;
      // Write access could be restricted based on user role/village
      allow write: if request.auth != null; 
    }
  }
}
